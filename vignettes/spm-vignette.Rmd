---
title: "spm: an R-infrastructure package for Stochastic Process Modeling of survival trajectories from longitudinal studies"
author: "Ilya Y. Zhbannikov"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{spm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Overview

The R-package \texttt{spm} (\url{https://github.com/izhbannikov/spm}) is developed for modeling trajectories from longitudinal data  and it allows (1) data simulation and (2) estimating the process parameters using maximum likelihood estimation by optimizing parameters used in the model. Specifically, developed R-package spm allows (i) one-dimensional SPM; (ii) multiple dimensional SPM; (iii) data simulation for one- and multiple dimensions.

## Data description

Data represents a typical longitudinal data in form of two datasets: longitudinal dataset (follow-up studies), in which one record represents a single observation, and vital (survival) statistics, where one record represents all information about the subject. Longitudinal dataset cat contain a subject ID (identification number), status (event(1)/no event(0)), time and measurements across the variables. The \texttt{spm} can handle an infinite number of variables but in practice, 5-7 variables is enough.

```{r,results='hide',warning=FALSE,echo=FALSE,message=FALSE}
library(spm)
# Reading longitude data:
longdat <- read.csv(system.file("data","longdat.csv",package="spm"))
# Prepare data for optimization:
vitstat <- read.csv(system.file("data","vitstat.csv",package="spm"))
```

Below there is an example of clinical data that can be used in \texttt{spm} and we will discuss the field later.
Longitudinal studies:
```{r,echo=FALSE}
head(longdat)
```
Vital statistics:
```{r,echo=FALSE}
head(vitstat)
```

#### Data fields description
##### Longitude studies
* ID - subject unique identificatin number.
* IndicatorDeath - 0/1, indicates death of a subject.
* Age - current age of subjects.
* AgeNext - next age of subject he will attend to the survey/exam.
* DBP, BMI - covariates, here "DBP" represents a diastolic blood pressure, "BMI" a body-mass index.

##### Vital statistics
* ID - subject's unique ID.
* IsDead - death indicator, 0 - alive, 1 - dead.
* LSmort - age at death of stopping observations.

## Discrete and Continuous cases

There are two main SPM types in the package: discrete model and continuous model. Discrete model assumes equal intervals between follow-up observations. The example of discrete dataset is given below.

```{r}
library(spm)
data <- simdata_discr_MD(N=10, ystart=c(80), k=1)
head(data)
```
In this case there are equal intervals between t1 and t2 (Age and Age.next).

The opposite is continuous case, in which intervals between observations are not equal. The example of continuous case dataset is shown below:

```{r}
library(spm)
data <- simdata_cont_MD(N=5,ystart = c(50))
head(data)
```



### Discrete case
In discrete case, we use the following assumptions:
$$ \bar{y}(t+1) = \bar{u} + \bar{R} \times \bar{y}(t) + \bar{\epsilon} $$
$$ \mu(t) = \mu_0(t) + \bar{b}(t) \times \bar{y}(t) + \bar{Q} \times \bar{y}(t)^2 $$

Where:
$$ \mu_0(t) = \mu_0 e^{\theta t} $$
$$ \bar{b}(t) = \bar{b} e^{\theta t} $$
$$ \bar{Q}(t) = \bar{Q} e^{\theta t} $$



## Continuous case

$$ \mu(u) = \mu_0(u) + (\bar{m}(u) - \bar{f}(u)^* \times \bar{Q}(u) \times (\bar{m}(u) - \bar{f}(u)) + Tr(\bar{Q}(u) \times \bar{\gamma}(u)) $$

$$ dm(t)/dt = \bar{a}(t) \times (\bar{m}(t) - \bar{f_1}(t)) - 2 \bar{\gamma}(t) \times \bar{Q}(t) \times (\bar{m}(t) - \bar{f}(t)) $$
$$ d\bar{\gamma}(t)/dt = \bar{a}(t) \times \bar{\gamma}(t) +  \bar{\gamma}(t) \times \bar{a}(t)^* + \bar{b}(t) \times \bar{b}(t)^* - 2 \bar{\gamma}{t} \times \bar{Q}(t) \times \bar{\gamma}(t) $$

## Coefficient conversion between continuous and discrete cases

$$ Q = Q $$
$$ \bar{a} = \bar{R} - diag(k) $$
$$ \bar{b} = \bar{\epsilon} $$
$$ \bar{f1} = -1 \times \bar{u} \times \bar{a^{-1}} $$
$$ \bar{f} = -0.5 \times \bar{b} \times \bar{Q^{-1}} $$
$$ mu_0 = mu_0 - \bar{f} \times \bar{Q} \times t(\bar{f}) $$
$$ \theta = \theta $$

## Case with time-dependent coefficients

In two previous cases, we assumed that coefficients is sort of time-dependant: we multiplied them on to $$e^{\theta t}$$. In general, this may not be the case. We extend this to a general case, i.e. (we consider one-dimensional case):

$$ \bar{a(t)} = par_1 t + par_2 $$ - linear function. 

The corresponding equations will be equivalent to one-dimensional continuous case described above.

## Simulation

We added one- and multi- dimensional simulation to be able to generate test data for hyphotesis testing. Data,  which can be simulated can be discrete (equal intervals between observations) and continuous (with arbitrary intervals).

## Discrete

For discrete case:

```{r}
library(spm)
data <- simdata_discr_MD(N=100, ystart=c(75, 94), k=2)
head(data)
```

## Continuous

For continuous case:

```{r}
library(spm)
data <- simdata_cont_MD(N=100)
head(data)
```



## Simulation strategies
R-package ```spm``` currently offers continuous- and discrete time simulations. 

### Continuous-time simulation

####Step 1
We come with a new subject and at first, we think that subject under study is alive at the starting observation time t1:

```
event(t1) = False
new_subject(t1) = True
```
Here ```event``` represents the particular event happened to the subject (for example, death or a failure).
Then we start observing the subject over time.

####Step 2
Computing t1 and t2:

```
if event = False and new_subject = True:
  t1 = runif(1, tstart, tend)
  t2 = t1 + 2*runif(1, 0, 1)
else if event = False and new_subject = False:
  t1 = t2
  t2 = t1 + 2*runif(1, 0, 1)
```

If we come with a "fresh" subject, we assume that t1 as a random value, uniformly distributed from start time (tstart) to end (tend). Here ```runif()``` a random number generator which returns uniformly distributed value (from tstart to tend).

####Step 3

Computing y1:

```
if event = False and new_subject = True:
  y1 = rnorm(1, ystart, sd0)
} else {
  y1 = y2
}
```

Here ```rnorm()``` a random number generator which returns normally distributed values, with mean=0 and sd=1.

####Step 4
Compute Survival Fuction ```S``` based on the equations above.

####Step 5

In this case we compare the ```S``` to the random number, uniformly distributed. If it is larger, than we assume that the event is happened (death of subject or system failure). Otherwise we proceed to the next iteration.
```
if S > runif(1, 0, 1) : 
    y2 = rnorm(1, m, sqrt(gamma))
    event = True
    new_subject = True
else if event = False:
  y2 = rnorm(1, m, sqrt(gamma))
  event = False
  new_record = True
```

###Discrete-time simulation

In this case we use equal intervals ```dt``` between observations and survival function ```S``` is computed directly from $\mu$:

$S = e^{-1\mu(t_1)}$

The rest of the discrete simulation routine is the same as in continuous-time simulation case.
